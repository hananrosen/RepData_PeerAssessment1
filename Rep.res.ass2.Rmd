---
title: "Extreme weather impact on human lives & economics."
author: "Hanan Rosen"
date: "Wednesday, October 15, 2014"
output: html_document
---
##Synopsis

This report summarizes the report of NOAA (the National Oceanic & Atmospheric Administration) of extreme weather events between the years 1950 - 2011.  
The summary concentrates on the total damage in two caterories: human lives (fatalities and injuries), and economics (property and crops).  
The damage is calculated for the USA as a whole during the whole period of the report.  
The 20 types of weather events, that have the greatest impact in each caterory, are displayed in a table and graphically.  

##Downloading the data.     
The NOAA's report can be found in the following URL:  
```{r}
fileUrl <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
```
It is downloaded to a file and read to the variable 'storms'. Since the reading last a very long time, it is recommended to save the variable for a later use:  
```{r}
download.file(fileUrl, destfile = "StormData.bz2")
storms <- read.csv("StormData.bz2")
save(storms, file = "StormData.var")
load("StormData.var")   #Run the program from here if the variable is already saved.
```  
###Checking the data.    
Here are the dimensions of the variable 'storms':  
```{r}
dim(storms)

```
The report deals with more than 900,000 events. For each events 37 variables are given. Most of them (like places and dates) are irrelevant for this summary. Here is a partial display of 'storms' with the 7 relevant variables:  
```{r}
head(storms[,c(8,23,24,25,26,27,28)])
```
The important variables are:   
EVTYPE      - Event type.  
FATALITIES.  
INJURIES.  
PROPDMG    - Damage to property.  
PROPDMGEXP - Multiplier of property damage.   
CROPDMG    - Damage to crops.  
CROPDMGEXP - Multiplier of crops damage.  
  
The multipliers should be one of 4 types:  
empty - if the damage column gives the exact damage.   
K - if the damage column gives the damage in thousands of dollars.  
M - if the damage column gives the damage in millions of dollars.   
B - if the damage column gives the damage in billions of dollars.   

It must be checked that the entries of these columns contain only valid data:   
```{r}
summary(storms$PROPDMGEXP)      
summary(storms$CROPDMGEXP)
```
It seems that although there are some invalid entries the great majority of the entries are valid. We cannot guess the meaning of the invalid entries, therefore they will be disregarded in this report.  
Next, the file is checked for non available ('NA') data:  
```{r}
sum(storms$CROPDMG[is.na(storms$CROPDMG)])  #Check for NA's
sum(storms$PROPDMG[is.na(storms$PROPDMG)])
sum(storms$INJURIES[is.na(storms$INJURIES)])
sum(storms$FATALITIES[is.na(storms$FATALITIES)])
```
It seems that the data is complete.  

##Data Processing.   
For processing, the 'dplyr' package is needed:   
```{r results='hide'}
library(dplyr)
```

###The impact on human lives.    
A data frame is created which contains only the variables that connect event types to human lives. these variables are: EVTYPE, FATALITIES and INJURIES:   
```{r}
stormsLife <- select(storms, EVTYPE, FATALITIES, INJURIES)
```
The following processing steps are taken:  
The number of fatalities and injuries that are caused by a specific event are summed.     
Events where the number of fatalities, or the number of injuries, is zero, are deleted.  
The data is ordered by the sum of fatalities and injuries in descending order.  
The 20 most severe types of events are selected.  
```{r}
fatalS <- aggregate(cbind(FATALITIES, INJURIES) ~ 
                        EVTYPE, sum, data = stormsLife)
fatalS <- fatalS[(fatalS$FATALITIES * fatalS$INJURIES != 0),] 
fatalS <- fatalS[order(desc(fatalS$FATALITIES + fatalS$INJURIES)),]
fatalS20 <- fatalS[1:20,]
```


###The impact on economics.      
The processing is very similar to the previous part. First a data frame is created with only the variables that connect event types to damage. These variables are: EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP:   
```{r}
dmg <- select(storms, EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)
```
However, before proceeding to summing and ordering the real value of the damage must be calculated. The real value is the multiplication of the number given in the damage column by the appropriate multiplier. New columns ('damageP' and 'damageC) are created which contain the real values of prorerty damage and crops damage respectively. To make the numbers more readable the values are given in billions of dollars:   
```{r results='hide'}
dmg <- mutate(dmg, damageP = round(1e-9*PROPDMG * 
                                      ( (PROPDMGEXP=="B")*1e9 +
                                            (PROPDMGEXP=="M")*1e6 +
                                            (PROPDMGEXP=="K")*1e3 +
                                            (PROPDMGEXP==""))),
                    damageC = round( 1e-9*CROPDMG * 
                                      ( (CROPDMGEXP=="B")*1e9 +
                                            (CROPDMGEXP=="M")*1e6 +
                                            (CROPDMGEXP=="K")*1e3 +
                                            (CROPDMGEXP=="")),1))
```

The following steps are:  
Select only the relevant columns: EVTYPE, damageP and damageC.  
Sum the damages by the event types.  
Order the table in descending order by the sum of damage to property and damage to crops.  
Select the most severe event types:    
```{r}
dmg <- select(dmg, EVTYPE, damageP, damageC)
dmg <- aggregate(cbind(damageP, damageC) ~ EVTYPE, sum, data = dmg)
dmg <- dmg[order(desc(dmg$damageP + dmg$damageC)),]
dmg <- dmg[1:20,]
```

     
##Results    
The impact on human lives, by type of event, is included in the variable 'fatals20' which was derived earlier, and can be seen in the following table:   
```{r}
fatalS20
```
The same results can be seen here, displayed in a stacked bar graph to show both the separate numbers of fatalities and injuries, and their sum. Note that because the number of injuries caused by tornados is over 90,000 and is by far larger than any other number in the table, the graph is cropped at 10,000. Displaying the tornado injuries if full would render all other bars invisible:  
```{r}
par(mar=c(8,4,4,2))
fatalTable <- rbind(fatalS20$FATALITIES, fatalS20$INJURIES)
rownames(fatalTable) <- c("FATALITIES", "INJURIES")
barplot(fatalTable, names.arg=fatalS20$EVTYPE, las=2,
        cex.names = 0.7, ylim=c(0,10000), legend=rownames(fatalTable),
        main = "Injuries & Fatalities by type of Storm")

```
  
    
The impact on economics, by type of event, is included in the variable 'dmg' which was derived earlier, and can be seen in the following table:    
```{r}
dmg
```

The same results can be seen here in a stacked bar graph to show both the separate damages to propery and crops and their sums:   
```{r}
dmgTable <- rbind(dmg$damageP, dmg$damageC)
rownames(dmgTable) <- c("Property", "Crops")
par(mar=c(10,4,4,2))
barplot(dmgTable, names.arg=dmg$EVTYPE, las=2,
        cex.names = 0.7, ylim=c(0,150),
        main = "Damages by type of Storm (in $ Billion)", 
        legend=rownames(dmgTable))
```



